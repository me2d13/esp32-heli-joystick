<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Debug - Heli Joystick</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <h1>üîß ESP32 Debug</h1>
        <p class="subtitle">System health & resource monitoring</p>

        <div class="cards-grid">
            <div class="card">
                <div class="card-title">üìä Memory</div>
                <div class="status-row">
                    <span class="status-label">Free Heap</span>
                    <span class="status-value" id="freeHeap">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Min Free Heap (lifetime)</span>
                    <span class="status-value" id="minFreeHeap">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Total Heap Size</span>
                    <span class="status-value" id="heapSize">--</span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">‚è±Ô∏è Runtime</div>
                <div class="status-row">
                    <span class="status-label">Uptime</span>
                    <span class="status-value" id="uptime">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Stack Free (main task)</span>
                    <span class="status-value" id="stackHighWaterMark">--</span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üñ•Ô∏è Chip</div>
                <div class="status-row">
                    <span class="status-label">Model</span>
                    <span class="status-value" id="chipModel">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Revision</span>
                    <span class="status-value" id="chipRevision">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">CPU Freq</span>
                    <span class="status-value" id="cpuFreqMHz">--</span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üì° Connection</div>
                <div class="status-row">
                    <span class="status-label">Last Update</span>
                    <span class="status-value" id="lastUpdate">--</span>
                </div>
            </div>

            <div class="card">
                <div class="card-title">‚öôÔ∏è Motor Debug</div>
                <div class="status-row">
                    <span class="status-label">Debug Mode</span>
                    <button id="btnMotorDebug" onclick="toggleMotorDebug()"
                        style="padding: 4px 8px; border-radius: 4px; border: 1px solid #45475a; background: #313244; color: #cdd6f4; cursor: pointer;">Enable</button>
                </div>
                <div id="motorControls" style="display: none; margin-top: 15px;">
                    <p style="font-size: 0.8em; color: #8892b0; margin-bottom: 8px;">Steps (negative = reverse)</p>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <input type="number" id="stepsInput" value="100"
                            style="width: 80px; padding: 4px; border-radius: 4px; border: 1px solid #45475a; background: #1e1e2e; color: #cdd6f4;">
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="moveMotor('X')"
                            style="flex: 1; padding: 6px; border-radius: 4px; border: 1px solid #89b4fa; background: #313244; color: #89b4fa; cursor: pointer;">Move
                            X</button>
                        <button onclick="moveMotor('Y')"
                            style="flex: 1; padding: 6px; border-radius: 4px; border: 1px solid #a6e3a1; background: #313244; color: #a6e3a1; cursor: pointer;">Move
                            Y</button>
                    </div>
                    <p id="motorStatus" style="font-size: 0.8em; color: #f38ba8; margin-top: 8px;"></p>
                </div>
            </div>

            <div class="card">
                <div class="card-title">‚è±Ô∏è Loop Task Timing (ms)</div>
                <p style="font-size: 0.8em; color: #8892b0; margin-bottom: 12px;">Last / Max per iteration. Logged when
                    &gt;50ms.</p>
                <div id="loopTasks"></div>
            </div>
        </div>

        <p class="footer">
            <a href="/" style="color: #64ffda;">‚Üê Back to Dashboard</a>
        </p>
    </div>

    <script>
        function formatBytes(n) {
            if (n === undefined || n === null) return '--';
            return n.toLocaleString() + ' B';
        }

        function formatUptime(ms) {
            if (ms === undefined || ms === null) return '--';
            const s = Math.floor(ms / 1000);
            const m = Math.floor(s / 60);
            const h = Math.floor(m / 60);
            if (h > 0) return h + 'h ' + (m % 60) + 'm ' + (s % 60) + 's';
            if (m > 0) return m + 'm ' + (s % 60) + 's';
            return s + 's';
        }

        function fetchDebug() {
            fetch('/api/debug')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('freeHeap').textContent = formatBytes(data.freeHeap);
                    document.getElementById('minFreeHeap').textContent = formatBytes(data.minFreeHeap);
                    document.getElementById('heapSize').textContent = formatBytes(data.heapSize);
                    document.getElementById('uptime').textContent = formatUptime(data.uptimeMs);
                    document.getElementById('stackHighWaterMark').textContent = formatBytes(data.stackHighWaterMark);
                    document.getElementById('chipModel').textContent = data.chipModel || '--';
                    document.getElementById('chipRevision').textContent = data.chipRevision ?? '--';
                    document.getElementById('cpuFreqMHz').textContent = (data.cpuFreqMHz ?? '--') + ' MHz';
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

                    const tasks = data.loopTasks;
                    const el = document.getElementById('loopTasks');
                    if (tasks && Array.isArray(tasks)) {
                        el.innerHTML = tasks.map(t => {
                            const maxClass = (t.maxMs || 0) > 50 ? 'status-offline' : '';
                            return '<div class="status-row"><span class="status-label">' + t.name + '</span>' +
                                '<span class="status-value ' + maxClass + '">' + (t.lastMs || 0) + ' / ' + (t.maxMs || 0) + '</span></div>';
                        }).join('');
                    }
                })
                .catch(err => {
                    document.getElementById('lastUpdate').textContent = 'Error: ' + err.message;
                });
        }

        let motorDebugActive = false;

        function toggleMotorDebug() {
            motorDebugActive = !motorDebugActive;
            const btn = document.getElementById('btnMotorDebug');
            const controls = document.getElementById('motorControls');

            btn.textContent = motorDebugActive ? 'Disable' : 'Enable';
            btn.style.background = motorDebugActive ? '#f38ba8' : '#313244';
            btn.style.color = motorDebugActive ? '#11111b' : '#cdd6f4';
            controls.style.display = motorDebugActive ? 'block' : 'none';

            fetch('/api/motor_debug', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ active: motorDebugActive })
            }).catch(e => console.error(e));
        }

        function moveMotor(axis) {
            if (!motorDebugActive) return;
            const steps = parseInt(document.getElementById('stepsInput').value) || 0;
            const payload = {};
            if (axis === 'X') payload.stepsX = steps;
            if (axis === 'Y') payload.stepsY = steps;

            document.getElementById('motorStatus').textContent = `Moving ${axis} ${steps} steps...`;

            fetch('/api/motor_debug', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                setTimeout(() => {
                    document.getElementById('motorStatus').textContent = "";
                }, 2000);
            }).catch(e => {
                document.getElementById('motorStatus').textContent = "Error: " + e.message;
            });
        }

        fetchDebug();
        setInterval(fetchDebug, 2000);
    </script>
</body>

</html>